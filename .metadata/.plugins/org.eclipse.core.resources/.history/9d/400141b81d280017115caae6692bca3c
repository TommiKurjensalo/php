<?php
require_once "PDO.php";

class Keijo {
public function keijollaOnKovaKasi($keijoNimi,$keijoKovaKasi) {

	// Luodaan SQL kysely tietojen lisäystä varten
	$sql = "SELECT keijoNimi, keijoKovaKasi 
			FROM keijo
			WHERE (keijoNimi = :keijoNimi
			AND keijoKovaKasi = :keijoKovaKasi)";

	// Valmistellaan lause
	$stmt = Database :: prepare($sql);

	// Jos lausetta ei ole onnistuneesti valmisteltu, annetaan virheilmoitus
	if (! $stmt = Database :: prepare($sql)) {
		$virhe = Database :: errorInfo();

		throw new PDOException($virhe[2], $virhe[1]);
	}
	
	// Asetetaan keijoNimi
	$stmt->bindValue(":keijoNimi", utf8_decode(".$keijoNimi."), PDO::PARAM_STR);

	// Asetetaan keijoKovaKasi
	$stmt->bindValue(":keijoKovaKasi", utf8_decode(".$keijoKovaKasi."), PDO::PARAM_STR);
	
	$tulos = array();

	// Jos SQL kyselylausekkeen ajo epäonnistuu, näytetään virheviesti
	if (! $stmt->execute()) {
		$virhe = $stmt->errorInfo();
		$tulos[] = $virhe;

		if ($virhe[0] == "HY093") {
			$virhe[2] = "Invalid parameter";
		}
		throw new PDOException($virhe[2], $virhe[1]);
	} else {
		$tulos[] = "tunnus ok";
	}

	// debuggausta varten
	if (isset($_COOKIE["isDebug"])) {
		echo "<br>nimi: ".	$keijoNimi. " pw: " .$keijoKovaKasi. "<br>";
		echo "SELECT keijoNimi, keijoKovaKasi 
			FROM keijo
			WHERE (keijoNimi = ".$keijoNimi."
			AND keijoKovaKasi = ".$keijoKovaKasi.")";
			
		echo '<br>';
	}
	
	// Määritellään kayttojarjestelmaId välille 1-4
	// Loopataan numeroiden 1-4 välillä
	if ($y >=4) { $y=1; } else { $y++; }
	
	// SQL lauseke
	$sql_linkkaus = "INSERT INTO lisaa_kayttojarjestelma (kayttoJarjestelmaId,lisaaId)
                     VALUE (:kayttoJarjestelmaId,:lisaaId);";
	
	// Valmistellaan lause
	$stmt_linkkaus = Database :: prepare($sql_linkkaus);
	
	// Jos lausetta ei ole onnistuneesti valmisteltu, annetaan virheilmoitus
	if (! $stmt_linkkaus = Database :: prepare($sql_linkkaus)) {
		$virhe_linkkaus = Database :: errorInfo();
	
		throw new PDOException($virhe_linkkaus[2], $virhe_linkkaus[1]);
	}
	
	// Asetetaan käyttöjärjestelmä id
	$stmt_linkkaus->bindValue(":kayttoJarjestelmaId", utf8_decode($y), PDO::PARAM_STR);
	
	// Asetetaan lisaa id
	$stmt_linkkaus->bindValue(":lisaaId", utf8_decode(Database::lastInsertId()), PDO::PARAM_INT);

	// Jos SQL kyselylausekkeen ajo epäonnistuu, näytetään virheviesti
	if (! $stmt_linkkaus->execute()) {
		$virhe_linkkaus = $stmt_linkkaus->errorInfo();
		$tulos[] = $virhe_linkkaus;
		if ($virhe_linkkaus[0] == "HY093") {
			$virhe_linkkaus[2] = "Invalid parameter";
		}

		throw new PDOException($virhe_linkkaus[2], $virhe_linkkaus[1]);
	} else {
		$tulos[] = "lisaa_kayttojarjestelma ok";
	}
	
	if (isset($_COOKIE["isDebug"])) {
		echo "INSERT INTO lisaa_kayttojarjestelma (kayttoJarjestelmaId,lisaaId)
              VALUE (\"".$y."\",\"".Database::lastInsertId()."\");";
	}

} // .for loop 


	$this->lkm = $stmt_lisaa->rowCount();
	$tulos[] = $this->lkm;
	return $tulos;

} // function keijollaOnKovaKasi
} // Luokka Keijo
?>